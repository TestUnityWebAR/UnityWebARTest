<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <title>Unity WebARProject</title>

    <button style="position:absolute;top:10px;left:10px;z-index:100;pointer-events:auto;"
       onclick="unityInstance.SendMessage('CubeSpawner','SpawnCube')">
     Spawn Cube
   </button>
    <!-- === Unity Canvas & Loading UI === -->
    <div id="unity-container">
      <canvas id="unity-canvas" width="960" height="600" tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"></div>
      <div id="unity-footer">
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">UnityWebARProject</div>
      </div>
    </div>

    <!-- === Unity Loader + AR.js → CubeSpawner Bridge === -->
    <script>
      // small banner for Unity warnings/errors
      function unityShowBanner(msg, type) {
        const b = document.querySelector("#unity-warning");
        const div = document.createElement("div");
        div.innerHTML = msg;
        if (type === "error") div.style = "background:red;padding:10px;";
        if (type === "warning") {
          div.style = "background:yellow;padding:10px;";
          setTimeout(()=>b.removeChild(div),5000);
        }
        b.appendChild(div);
      }

      // refs & config
      const canvas    = document.getElementById("unity-canvas");
      const marker    = document.getElementById("marker");
      const loaderUrl = "Build/UnityWebARTest.loader.js";
      const config    = {
        dataUrl:    "Build/UnityWebARTest.data",
        frameworkUrl:"Build/UnityWebARTest.framework.js",
        codeUrl:    "Build/UnityWebARTest.wasm",
        streamingAssetsUrl:"StreamingAssets",
        showBanner:   unityShowBanner,
        webglContextAttributes: {
          alpha:             true,
          premultipliedAlpha:false
        }
      };

      // inject Unity loader
      const loader = document.createElement("script");
      loader.src = loaderUrl;
      loader.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          document.querySelector("#unity-progress-bar-full")
                  .style.width = (100*progress) + "%";
        }).then(unityInstance => {
          window.unityInstance = unityInstance;
          document.querySelector("#unity-loading-bar").style.display = "none";

          // helpers for CubeSpawner
          const sendState = v =>
            unityInstance.SendMessage("CubeSpawner","SetTracking",v);

          const sendPose = () => {
              if (!unityInstance || !marker.object3D.visible) return;
              const { position: p, quaternion: q } = marker.object3D;

              // cm→m scale, but **no** invert on Z this time:
              const ux = p.x / 100;
              const uy = p.y / 100;
              const uz = p.z / 100;         // <-- positive p.z becomes negative in world

              // Handedness for rotation (keep as you had):
              const rx = -q.x;
              const ry = -q.y;
              const rz =  q.z;
              const rw =  q.w;

              const payload = JSON.stringify({
                position: { x: ux, y: uy, z: uz },
                rotation: { x: rx, y: ry, z: rz, w: rw }
              });

              console.log("JS → Unity JSON:", payload);
              unityInstance.SendMessage("CubeSpawner", "UpdateTransformData", payload);
            };

            marker.addEventListener("markerFound", () => {
              unityInstance.SendMessage("CubeSpawner", "SetTracking", 1);
              sendPose();
              unityInstance.SendMessage("CubeSpawner", "SpawnCube");
            });
            marker.addEventListener("markerLost",  () => unityInstance.SendMessage("CubeSpawner", "SetTracking", 0));
            marker.addEventListener("componentchanged", sendPose);

          }).catch(console.error);
        };
        document.body.appendChild(loader);
    </script>
  </body>
</html>

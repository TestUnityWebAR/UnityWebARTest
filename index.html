<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <title>Unity WebARProject</title>

    <!-- 1) A-Frame + AR.js for NFT tracking -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

    <style>
      html, body { margin:0; padding:0; overflow:hidden; background:transparent; }
      /* AR.js scene full-screen behind Unity */
      #scene {
        position:absolute; top:0; left:0;
        width:100vw; height:100vh;
      }
      /* Unity canvas sits on top—but remains transparent */
      #unity-container, #unity-canvas {
        position:absolute; top:0; left:0;
        width:100vw; height:100vh;
        background:transparent !important;
        pointer-events:none;
      }
      canvas { background:transparent !important; }
    </style>
  </head>
  <body>
    <!-- === AR.js Scene === -->
    <a-scene
      id="scene"
      embedded
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true; alpha: true"
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: true;"
    >
      <a-nft
        id="marker"
        type="nft"
        url="UnityWebARTest/Descriptors/test2"
        smooth="true" smoothCount="10"
        smoothTolerance="0.01" smoothThreshold="5"
      >
        <a-light type="ambient" intensity="1"></a-light>
      </a-nft>
      <a-entity camera></a-entity>
    </a-scene>

    <!-- === Unity Canvas & Loading UI === -->
    <div id="unity-container">
      <canvas id="unity-canvas" width="960" height="600" tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"></div>
      <div id="unity-footer">
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">UnityWebARProject</div>
      </div>
    </div>

    <!-- === Unity Loader + AR.js → CubeSpawner Bridge === -->
    <script>
      // small banner for Unity warnings/errors
      function unityShowBanner(msg, type) {
        const b = document.querySelector("#unity-warning");
        const div = document.createElement("div");
        div.innerHTML = msg;
        if (type === "error") div.style = "background:red;padding:10px;";
        if (type === "warning") {
          div.style = "background:yellow;padding:10px;";
          setTimeout(()=>b.removeChild(div),5000);
        }
        b.appendChild(div);
      }

      // refs & config
      const canvas    = document.getElementById("unity-canvas");
      const marker    = document.getElementById("marker");
      const loaderUrl = "Build/UnityWebARTest.loader.js";
      const config    = {
        dataUrl:    "Build/UnityWebARTest.data",
        frameworkUrl:"Build/UnityWebARTest.framework.js",
        codeUrl:    "Build/UnityWebARTest.wasm",
        streamingAssetsUrl:"StreamingAssets",
        showBanner:   unityShowBanner,
        webglContextAttributes: {
          alpha:             true,
          premultipliedAlpha:false
        }
      };

      // inject Unity loader
      const loader = document.createElement("script");
      loader.src = loaderUrl;
      loader.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          document.querySelector("#unity-progress-bar-full")
                  .style.width = (100*progress) + "%";
        }).then(unityInstance => {
          window.unityInstance = unityInstance;
          document.querySelector("#unity-loading-bar").style.display = "none";

          // helpers for CubeSpawner
          const sendState = v =>
            unityInstance.SendMessage("CubeSpawner","SetTracking",v);

          const sendPose = () => {
            if (!marker.object3D.visible) return;
            const {position:p, quaternion:q} = marker.object3D;
            // scale cm → m and invert Z
            const ux =  p.x / 100;
            const uy =  p.y / 100;
            const uz = -p.z / 100;

            // adjust quaternion handedness
            const rx = -q.x, ry = -q.y, rz = q.z, rw = q.w;

            // build the JSON exactly matching your C# MarkerData
            const payload = JSON.stringify({
              position: { x: ux, y: uy, z: uz },
              rotation: { x: rx, y: ry, z: rz, w: rw }
            });

            // 🔍 Log it so you can paste into Unity console
            console.log("JS → Unity JSON:", payload);

            unityInstance.SendMessage(
              "CubeSpawner",
              "UpdateTransformData",
              payload
            );
          };

          // wire AR.js events → CubeSpawner
          marker.addEventListener("markerFound", ()=>{
            sendState(1);
            sendPose();
            unityInstance.SendMessage("CubeSpawner","SpawnCube");
          });
          marker.addEventListener("markerLost",  ()=> sendState(0));
          marker.addEventListener("componentchanged", sendPose);

        }).catch(console.error);
      };
      document.body.appendChild(loader);
    </script>
  </body>
</html>

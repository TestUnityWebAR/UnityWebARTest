<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <title>Unity WebARProject</title>

    <!-- 1) A-Frame + AR.js for NFT tracking -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: transparent;
      }
      /* AR.js scene fills the back */
      #scene {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
      }
      /* Unity canvas sits on top, stays transparent */
      #unity-container,
      #unity-canvas,
      canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: transparent !important;
        pointer-events: none;
      }
    </style>

    <!-- 2) Define cube-follow with debug logs BEFORE the scene -->
    <script>
      AFRAME.registerComponent("cube-follow", {
        init: function () {
          this.spawned = false;
          console.log("[cube-follow] init on", this.el.tagName, "#"+this.el.id);
        },
        tick: function () {
          const unity = window.unityInstance;
          if (!unity || typeof unity.SendMessage !== "function") {
            console.log("[cube-follow] waiting for Unity…");
            return;
          }

          const vis = this.el.object3D.visible;
          console.log(
            `[cube-follow] tick – visible: ${vis}, spawned: ${this.spawned}`
          );

          // first sight → spawn
          if (vis && !this.spawned) {
            console.log("[cube-follow] → spawning cube");
            unity.SendMessage("CubeSpawner", "SetTracking", 1);
            unity.SendMessage("CubeSpawner", "SpawnCube");
            this.spawned = true;
          }

          // while visible → update pose
          if (vis && this.spawned) {
            console.log("[cube-follow] → updating pose");
            const { position: p, quaternion: q } = this.el.object3D;
            unity.SendMessage(
              "CubeSpawner",
              "UpdateTransformData",
              JSON.stringify({
                position: { x: p.x / 100, y: p.y / 100, z: p.z / 100 },
                rotation: { x: -q.x, y: -q.y, z: q.z, w: q.w },
              })
            );
          }

          // lost → disable
          if (!vis && this.spawned) {
            console.log("[cube-follow] → lost marker");
            unity.SendMessage("CubeSpawner", "SetTracking", 0);
            this.spawned = false;
          }
        },
      });
    </script>
  </head>

  <body>
    <!-- === AR.js Scene === -->
    <a-scene
      id="scene"
      embedded
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true; alpha: true"
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: true;"
    >
      <a-nft
        id="marker"
        type="nft"
        url="UnityWebARTest/Descriptors/test2"
        smooth="true"
        smoothCount="10"
        smoothTolerance="0.01"
        smoothThreshold="5"
        cube-follow
      >
        <a-light type="ambient" intensity="1"></a-light>
      </a-nft>

      <a-entity camera></a-entity>
    </a-scene>

    <!-- === Unity Canvas & Loading UI === -->
    <div id="unity-container">
      <canvas id="unity-canvas" width="960" height="600" tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"></div>
      <div id="unity-footer">
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">UnityWebARProject</div>
      </div>
    </div>

    <!-- === Unity Loader Script === -->
    <script>
      function unityShowBanner(msg, type) {
        const b = document.querySelector("#unity-warning");
        const d = document.createElement("div");
        d.innerHTML = msg;
        d.style =
          type === "error"
            ? "background:red;padding:10px;"
            : type === "warning"
            ? "background:yellow;padding:10px;"
            : "";
        b.appendChild(d);
        if (type === "warning") setTimeout(() => b.removeChild(d), 5000);
      }

      const canvas = document.getElementById("unity-canvas");
      const loaderUrl = "Build/UnityWebARTest.loader.js";
      const config = {
        dataUrl: "Build/UnityWebARTest.data",
        frameworkUrl: "Build/UnityWebARTest.framework.js",
        codeUrl: "Build/UnityWebARTest.wasm",
        streamingAssetsUrl: "StreamingAssets",
        showBanner: unityShowBanner,
        webglContextAttributes: {
          alpha: true,
          premultipliedAlpha: false,
        },
      };

      const script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          document.querySelector("#unity-progress-bar-full").style.width =
            100 * progress + "%";
        })
          .then((unityInstance) => {
            window.unityInstance = unityInstance;
            document.querySelector("#unity-loading-bar").style.display =
              "none";
          })
          .catch(console.error);
      };
      document.body.appendChild(script);
    </script>
  </body>
</html>
<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <title>Unity WebARProject</title>

    <!-- 1) A-Frame + AR.js -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

    <style>
      html, body {
        margin:0; padding:0; overflow:hidden; background:transparent;
      }
      /* AR.js always on top when debugging */
      #scene {
        position:absolute; top:0; left:0;
        width:100vw; height:100vh;
        z-index: 2;
      }
      /* Unity canvas starts hidden underneath */
      #unity-container,
      #unity-canvas,
      canvas {
        position:absolute; top:0; left:0;
        width:100vw; height:100vh;
        background:transparent !important;
        pointer-events:none;
        z-index: 1;
        display: none;               /* ← hide until marker found */
      }
    </style>

    <script>
      // 2) marker-events—logs and shows Unity on find
      AFRAME.registerComponent('marker-events', {
        init: function () {
          this.el.addEventListener('markerFound', () => {
            console.log(`[marker-events] found: #${this.el.id}`);
            document.getElementById('unity-container').style.display = 'block';
          });
          this.el.addEventListener('markerLost', () => {
            console.log(`[marker-events] lost:  #${this.el.id}`);
            document.getElementById('unity-container').style.display = 'none';
          });
        }
      });
      AFRAME.registerComponent("cube-follow", {
        init: function () {
          this.spawned = false;
          this.cameraEl = this.el.sceneEl.querySelector("[camera]");

          // Spawn cube on the exact frame the marker appears
          this.el.addEventListener("markerFound", () => {
            console.log("[cube-follow] markerFound → spawning");
            window.unityInstance.SendMessage("CubeSpawner", "SetTracking", 1);
            window.unityInstance.SendMessage("CubeSpawner", "SpawnCube");
            this.spawned = true;
          });

          // Destroy/hide cube the instant the marker vanishes
          this.el.addEventListener("markerLost", () => {
            console.log("[cube-follow] markerLost → destroying");
            window.unityInstance.SendMessage("CubeSpawner", "SetTracking", 0);
            this.spawned = false;
          });
        },

        tick: function () {
          // Only send pose updates if we have spawned the cube
          if (!this.spawned || !window.unityInstance?.SendMessage) return;

          // Compute camera-relative marker pose exactly as before
          const markerMat = this.el.object3D.matrixWorld;
          const camMat    = this.cameraEl.object3D.matrixWorld;
          const camInv    = new THREE.Matrix4().copy(camMat).invert();
          const relMat    = new THREE.Matrix4().multiplyMatrices(camInv, markerMat);

          const relPos  = new THREE.Vector3().setFromMatrixPosition(relMat);
          const relQuat = new THREE.Quaternion().setFromRotationMatrix(relMat);

          // Send updated transform each frame
          window.unityInstance.SendMessage(
            "CubeSpawner", "UpdateTransformData",
            JSON.stringify({
              position: { x: relPos.x/100, y: relPos.y/100, z: -relPos.z/100 },
              rotation: { x: -relQuat.x, y: -relQuat.y, z: relQuat.z, w: relQuat.w }
            })
          );
        }
      });
    </script>
  </head>

  <body>
    <!-- === AR.js NFT Scene === -->
    <a-scene
      id="scene"
      embedded
      vr-mode-ui="enabled: false"
      renderer="alpha:true;antialias:true"
      arjs="trackingMethod:best; sourceType:webcam; debugUIEnabled:true;"
    >
      <a-nft
        id="marker"
        type="nft"
        url="UnityWebARTest/Descriptors/test2"
        smooth="true"
        smoothCount="10"
        smoothTolerance="0.01"
        smoothThreshold="5"
        marker-events
        cube-follow
      >
        <a-light type="ambient" intensity="1"></a-light>
      </a-nft>

      <a-entity camera></a-entity>
    </a-scene>

    <!-- === Unity Canvas & Loader === -->
    <div id="unity-container">
      <canvas id="unity-canvas" width="960" height="600" tabindex="-1"></canvas>
      <!-- … your existing loading UI … -->
    </div>
    <script>
      // … your unchanged Unity loader script here …
    </script>
  </body>
</html>
<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8" />
  <title>Unity WebARProject</title>

  <!-- 1) A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

  <style>
    html, body { margin:0; padding:0; overflow:hidden; background:#000; }
    /* AR.js scene behind when Unity is hidden */
    #scene {
      position:absolute; top:0; left:0;
      width:100vw; height:100vh;
      z-index:1;
    }
    /* Unity canvas & container always full-screen, but hidden via visibility */
    #unity-container,
    #unity-canvas {
      position:absolute; 
      top:0; left:0;
      width:100vw; height:100vh;
      background:transparent !important;
      pointer-events:none;
      visibility:hidden;   /* keep size, just hide */
      z-index:0;
    }
    /* show Unity when both ready + marker visible */
    #unity-container.show {
      visibility:visible;
      z-index:2;
    }
  </style>

  <script>
    // State flags
    let unityReady     = false;
    let markerVisible  = false;
    let hasSpawnedCube = false;

    // Toggle the .show class on the Unity container
    function updateUnityVisibility() {
      const c = document.getElementById("unity-container");
      if (unityReady && markerVisible) {
        c.classList.add("show");
      } else {
        c.classList.remove("show");
      }
    }

    // cube-follow component: hooks markerFound/markerLost & streams pose
    AFRAME.registerComponent("cube-follow", {
      init: function () {
        // Grab the camera entity
        this.cameraEl = this.el.sceneEl.querySelector("[camera]");

        // On first detect: show Unity + spawn cube
        this.el.addEventListener("markerFound", () => {
          console.log("[cube-follow] markerFound");
          markerVisible = true;
          updateUnityVisibility();

          if (unityReady && !hasSpawnedCube) {
            console.log("[cube-follow] â†’ SendMessage SpawnCube");
            window.unityInstance.SendMessage("CubeSpawner", "SetTracking", 1);
            window.unityInstance.SendMessage("CubeSpawner", "SpawnCube");
            hasSpawnedCube = true;
          }
        });

        // On lost: hide Unity + destroy cube
        this.el.addEventListener("markerLost", () => {
          console.log("[cube-follow] markerLost");
          markerVisible = false;
          updateUnityVisibility();

          if (unityReady && hasSpawnedCube) {
            window.unityInstance.SendMessage("CubeSpawner", "SetTracking", 0);
            hasSpawnedCube = false;
          }
        });
      },

      tick: function () {
        // Only stream pose if weâ€™ve spawned and Unityâ€™s ready
        if (!unityReady || !markerVisible || !hasSpawnedCube) return;

        const u = window.unityInstance;
        // worldâ†’camera-relative matrix math
        const markerMat = this.el.object3D.matrixWorld;
        const camMat    = this.cameraEl.object3D.matrixWorld;
        const camInv    = new THREE.Matrix4().copy(camMat).invert();
        const relMat    = new THREE.Matrix4().multiplyMatrices(camInv, markerMat);
        const relPos    = new THREE.Vector3().setFromMatrixPosition(relMat);
        const relQuat   = new THREE.Quaternion().setFromRotationMatrix(relMat);

        // send it in metres & flip Z
        u.SendMessage(
          "CubeSpawner",
          "UpdateTransformData",
          JSON.stringify({
            position: { x: relPos.x/100, y: relPos.y/100, z: -relPos.z/100 },
            rotation: { x: -relQuat.x,  y: -relQuat.y,  z: relQuat.z, w: relQuat.w }
          })
        );
      }
    });
  </script>
</head>
<body>
  <!-- AR.js scene -->
  <a-scene
    id="scene"
    embedded
    vr-mode-ui="enabled: false"
    renderer="alpha:true;antialias:true"
    background="color: #000000; opacity: 0"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: true;"
  >
    <a-nft
      id="marker"
      type="nft"
      url="UnityWebARTest/Descriptors/test2"
      smooth="true" smoothCount="10"
      smoothTolerance="0.01" smoothThreshold="5"
      cube-follow
    >
      <a-light type="ambient" intensity="1"></a-light>
    </a-nft>
    <a-entity camera></a-entity>
  </a-scene>

  <!-- Unity canvas + loader -->
  <div id="unity-container">
    <canvas id="unity-canvas" width="960" height="600"></canvas>
    <div id="unity-loading-bar">
      <div id="unity-logo"></div>
      <div id="unity-progress-bar-empty">
        <div id="unity-progress-bar-full"></div>
      </div>
    </div>
    <div id="unity-warning"></div>
    <div id="unity-footer">
      <div id="unity-fullscreen-button"></div>
      <div id="unity-build-title">UnityWebARProject</div>
    </div>
  </div>

  <!-- Unity loader script -->
  <script>
    function unityShowBanner(msg,type) {
      const b=document.querySelector("#unity-warning"),
            d=document.createElement("div");
      d.innerHTML = msg;
      d.style = type==="error"
                ? "background:red;padding:10px;"
                : (type==="warning"
                   ? "background:yellow;padding:10px;"
                   : "");
      b.appendChild(d);
      if(type==="warning") setTimeout(()=>b.removeChild(d),5000);
    }

    const canvas    = document.getElementById("unity-canvas"),
          loaderUrl = "Build/UnityWebARTest.loader.js",
          config    = {
            dataUrl:    "Build/UnityWebARTest.data",
            frameworkUrl:"Build/UnityWebARTest.framework.js",
            codeUrl:    "Build/UnityWebARTest.wasm",
            streamingAssetsUrl:"StreamingAssets",
            showBanner: unityShowBanner,
            webglContextAttributes:{ alpha:true, premultipliedAlpha:false }
          };

    console.log("Injecting Unity loader:", loaderUrl);
    const unityLoader = document.createElement("script");
    unityLoader.src = loaderUrl;

    unityLoader.onload = () => {
      console.log("Unity loader loaded, creating instanceâ€¦");
      createUnityInstance(canvas, config, (p) => {
        console.log("Unity load:", (p*100).toFixed(1) + "%");
        document.querySelector("#unity-progress-bar-full").style.width =
          (p*100) + "%";
      })
      .then(inst => {
        console.log("ðŸš€ Unity instance created");
        window.unityInstance = inst;
        unityReady = true;
        updateUnityVisibility();
      })
      .catch(err => {
        console.error("Unity load failed:", err);
        unityShowBanner("Unity failed to load", "error");
      });
    };

    unityLoader.onerror = (e) => {
      console.error("Error loading Unity loader script:", e);
      unityShowBanner("Could not load Unity loader.js", "error");
    };

    document.body.appendChild(unityLoader);
  </script>
</body>
</html>
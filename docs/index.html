<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Unity WebAR Cube Spawner</title>

    <!-- A-Frame core + AR.js NFT build -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

    <style>
      html, body { margin:0; padding:0; overflow:hidden; background:transparent; }
      #scene { position:absolute; top:0; left:0; width:100vw; height:100vh; }
      #unity-container, #unity-canvas, canvas {
        position:absolute; top:0; left:0;
        width:100vw; height:100vh;
        background:transparent !important;
        pointer-events:none;
      }
    </style>
  </head>

  <body>
    <!-- AR.js scene with NFT marker -->
    <a-scene
      id="scene"
      embedded
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true; alpha: true"
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
    >
      <a-nft
        id="marker"
        type="nft"
        url="UnityWebARTest/StreamingAssets/Descriptors/test2"
        size="0.045"
      >
        <a-light type="ambient" intensity="1"></a-light>
      </a-nft>
      <a-entity camera></a-entity>
    </a-scene>

    <!-- Unity canvas and loading UI -->
    <div id="unity-container">
      <canvas id="unity-canvas" width="960" height="600" tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"></div>
      <div id="unity-footer">
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">Unity WebARProject</div>
      </div>
    </div>

    <!-- Marker event handlers: register only after checking unityInstance -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const marker = document.querySelector('#marker');

        marker.addEventListener('markerFound', () => {
          if (!window.unityInstance) {
            console.warn('Unity instance not ready yet');
            return;
          }
          window.unityInstance.SendMessage('CubeSpawner', 'SpawnCube');
        });

        marker.addEventListener('markerLost', () => {
          if (!window.unityInstance) return;
          window.unityInstance.SendMessage('CubeSpawner', 'SetTracking', 0);
        });
      });
    </script>

    <!-- Unity loader script -->
    <script>
      function unityShowBanner(msg, type) {
        const b = document.querySelector('#unity-warning');
        const d = document.createElement('div');
        d.innerHTML = msg;
        d.style = type === 'error'
          ? 'background:red;padding:10px;'
          : type === 'warning'
          ? 'background:yellow;padding:10px;'
          : '';
        b.appendChild(d);
        if (type === 'warning') setTimeout(() => b.removeChild(d), 5000);
      }

      const canvas = document.getElementById('unity-canvas');
      const loaderUrl = 'Build/docs.loader.js';
      const config = {
        dataUrl: 'Build/docs.data',
        frameworkUrl: 'Build/docs.framework.js',
        codeUrl: 'Build/docs.wasm',
        streamingAssetsUrl: 'StreamingAssets',
        showBanner: unityShowBanner,
        webglContextAttributes: { alpha: true, premultipliedAlpha: false }
      };

      const loader = document.createElement('script');
      loader.src = loaderUrl;
      loader.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          document.querySelector('#unity-progress-bar-full').style.width =
            (100 * progress).toFixed(1) + '%';
        })
        .then((instance) => {
          window.unityInstance = instance;
          document.querySelector('#unity-loading-bar').style.display = 'none';
        })
        .catch((error) => {
          console.error(error);
          unityShowBanner('Unity failed to load', 'error');
        });
      };
      loader.onerror = (e) => unityShowBanner('Could not load Unity loader.js', 'error');
      document.body.appendChild(loader);
    </script>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
	  <!-- Loading framework/library -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>
    <style>
      /* Full-screen background, let Unity canvas stay transparent */
      html, body { margin:0; padding:0; overflow:hidden; background:transparent }
      #scene { position:absolute; top:0; left:0; width:100vw; height:100vh }
      #unity-container,
      #unity-canvas,
      canvas {
        position:absolute; top:0; left:0;
        width:100vw; height:100vh;
        background:transparent !important;
        pointer-events:none;
      }
    </style>
    <!-- Your custom A-Frame component to forward marker events into Unity -->
    <script>
      AFRAME.registerComponent("cube-follow", {
        init() {
          this.spawned = false;
          this.lostCount = 0;
          this.marker = this.el;
          this.cam = this.el.sceneEl.querySelector("[camera]");

          this.el.addEventListener("markerFound", () => {
            this.lostCount = 0;
            const unity = window.unityInstance;
            if (unity?.SendMessage && !this.spawned) {
              unity.SendMessage("CubeSpawner","SetTracking",1);
              unity.SendMessage("CubeSpawner","SpawnCube");
              this.spawned = true;
            }
          });

          this.el.addEventListener("markerLost", () => {
            // debounce on tick()
          });
        },

        tick() {
          if (!this.spawned) return;
          const vis = this.marker.object3D.visible;
          const unity = window.unityInstance;
          if (!vis) {
            if (++this.lostCount > 5) {
              unity.SendMessage("CubeSpawner","SetTracking",0);
              this.spawned = false;
              this.lostCount = 0;
            }
          } else {
            this.lostCount = 0;
            // compute pose & send transform updates…
            const markerMat = this.marker.object3D.matrixWorld;
            const camMat = this.cam.object3D.matrixWorld;
            const relMat = new THREE.Matrix4().copy(camMat).invert().multiply(markerMat);
            const pos = new THREE.Vector3().setFromMatrixPosition(relMat);
            const quat = new THREE.Quaternion().setFromRotationMatrix(relMat);
            const FACTOR = 3.0; // tune to match Unity’s units

            unity.SendMessage("CubeSpawner","UpdateTransformData",
              JSON.stringify({
                position: {
                  x: (pos.x),
                  y: (pos.y),
                  z: -(pos.z)
                },
                rotation: {
                  x: -quat.x, 
                  y: -quat.y, 
                  z: quat.z, 
                  w: quat.w
                }
              })
            );
          }
        }
      });
    </script>
  </head>

    <body>
    <!-- AR.js scene behind everything -->
    <a-scene
      id="scene"
      embedded
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true; alpha: true"
      arjs="trackingMethod: best;
            sourceType: webcam;
            debugUIEnabled: true;">
      
      <a-nft
        id="marker"
        type="nft"
        url="UnityWebARTest/StreamingAssets/Descriptors/test2"
        size="0.045"
        smooth="true"
        smoothCount="20"
        smoothTolerance="0.05"
        smoothThreshold="7"
        detectMinSimilarity="0.6"
        cube-follow>                <!-- attach your Unity bridge component -->
        
        <a-light type="ambient" intensity="1"></a-light>
        <!-- no <a-box> here: Unity will spawn the cube instead -->
      </a-nft>

      <a-entity camera></a-entity>
    </a-scene>
    <!-- Unity canvas and loading UI float on top -->
    <div id="unity-container">
      <canvas id="unity-canvas" width="960" height="600" tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"></div>
      <div id="unity-footer">
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">Unity WebARProject</div>
      </div>
    </div>

    <!-- Unity loader script -->
    <script>
      function unityShowBanner(msg, type) {
        const b = document.querySelector("#unity-warning");
        const d = document.createElement("div");
        d.innerHTML = msg;
        d.style = type==="error"
          ? "background:red;padding:10px;"
          : type==="warning"
          ? "background:yellow;padding:10px;"
          : "";
        b.appendChild(d);
        if (type==="warning") setTimeout(()=>b.removeChild(d),5000);
      }

      const canvas = document.getElementById("unity-canvas");
      const loaderUrl = "Build/docs.loader.js";
      const config = {
        dataUrl: "Build/docs.data",
        frameworkUrl: "Build/docs.framework.js",
        codeUrl: "Build/docs.wasm",
        streamingAssetsUrl: "StreamingAssets",
        showBanner: unityShowBanner,
        webglContextAttributes: { alpha: true, premultipliedAlpha: false }
      };

      const loader = document.createElement("script");
      loader.src = loaderUrl;
      loader.onload = () => {
        createUnityInstance(canvas, config, (p)=> {
          document.querySelector("#unity-progress-bar-full").style.width = (100*p).toFixed(1)+"%";
        }).then((instance)=> {
          window.unityInstance = instance;
          document.querySelector("#unity-loading-bar").style.display="none";
        }).catch((e)=> {
          console.error(e);
          unityShowBanner("Unity failed to load","error");
        });
      };
      loader.onerror = (e)=> unityShowBanner("Could not load Unity loader.js","error");
      document.body.appendChild(loader);
      </script>
    </body>
  </html>
  </body>
</html>
<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <title>Unity WebAR Cube Spawner</title>

    <!-- 1) A-Frame core + AR.js NFT build -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

    <style>
      /* full-screen AR.js background */
      html, body { margin:0; padding:0; overflow:hidden; background:transparent }
      #scene { position:absolute; top:0; left:0; width:100vw; height:100vh; z-index:0 }

      /* Unity’s transparent WebGL canvas on top */
      #unity-container,
      #unity-canvas,
      canvas {
        position:absolute; top:0; left:0;
        width:100vw; height:100vh;
        background:transparent!important;
        pointer-events:none;
        z-index:1;
      }
    </style>

    <!-- 2) cube-follow component: spawn, destroy, per-frame pose → Unity -->
    <script>
      AFRAME.registerComponent('cube-follow', {
        init() {
          this.spawned = false;
          this.marker  = this.el;
          this.cam     = this.el.sceneEl.querySelector('[camera]');

          // on first sight, tell Unity to spawn + start tracking
          this.marker.addEventListener('markerFound', () => {
            if (this.spawned || !window.unityInstance?.SendMessage) return;
            window.unityInstance.SendMessage('CubeSpawner','SetTracking', 1);
            window.unityInstance.SendMessage('CubeSpawner','SpawnCube');
            this.spawned = true;
          });

          // as soon as marker is lost, destroy cube
          this.marker.addEventListener('markerLost', () => {
            if (!this.spawned || !window.unityInstance?.SendMessage) return;
            window.unityInstance.SendMessage('CubeSpawner','SetTracking', 0);
            this.spawned = false;
          });
        },

        tick() {
          if (!this.spawned || !this.marker.object3D.visible || !window.unityInstance?.SendMessage) return;

          // grab A-Frame’s built-in world-space pose (in meters)
          const p = this.marker.object3D.position;
          const q = this.marker.object3D.quaternion;

          // flip Z & invert X/Y to match Unity’s conventions
          const payload = JSON.stringify({
            position: { x: p.x,    y: p.y,    z: -p.z },
            rotation: { x: -q.x,   y: -q.y,   z: q.z, w: q.w }
          });

          window.unityInstance.SendMessage(
            'CubeSpawner',
            'UpdateTransformData',
            payload
          );
        }
      });
    </script>
  </head>

  <body>
    <!-- === AR.js NFT scene (behind) === -->
    <a-scene
      id="scene"
      embedded
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true; alpha: true"
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
    >
      <a-nft
        id="marker"
        type="nft"
        url="UnityWebARTest/StreamingAssets/Descriptors/test2"
        size="0.2"             <!-- your physical marker size in meters -->
        cube-follow           <!-- attach our component -->
      >
        <a-light type="ambient" intensity="1"></a-light>
      </a-nft>
      <a-entity camera></a-entity>
    </a-scene>

    <!-- === Unity WebGL overlay (on top) === -->
    <div id="unity-container">
      <canvas id="unity-canvas" width="960" height="600" tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"></div>
      <div id="unity-footer">
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">Unity WebARProject</div>
      </div>
    </div>

    <!-- 3) Unity loader + banner + logging -->
    <script>
      function unityShowBanner(msg, type) {
        const b = document.querySelector('#unity-warning');
        const d = document.createElement('div');
        d.innerHTML = msg;
        d.style = type==='error'
          ? 'background:red;padding:10px;'
          : type==='warning'
          ? 'background:yellow;padding:10px;'
          : '';
        b.appendChild(d);
        if (type === 'warning') setTimeout(() => b.removeChild(d), 5000);
      }

      const canvas    = document.getElementById('unity-canvas');
      const loaderUrl = 'Build/docs.loader.js';  // adjust path if needed
      const config    = {
        dataUrl:            'Build/docs.data',
        frameworkUrl:       'Build/docs.framework.js',
        codeUrl:            'Build/docs.wasm',
        streamingAssetsUrl: 'StreamingAssets',
        showBanner:         unityShowBanner,
        webglContextAttributes: { alpha:true, premultipliedAlpha:false }
      };

      console.log('→ injecting Unity loader:', loaderUrl);
      const loader = document.createElement('script');
      loader.src = loaderUrl;
      loader.onload = () => {
        console.log('Unity loader loaded; calling createUnityInstance()');
        if (!window.unityInstance) {
          createUnityInstance(canvas, config, (progress) => {
            const pct = (100*progress).toFixed(1)+'%';
            console.log('Unity load progress:', pct);
            document.querySelector('#unity-progress-bar-full').style.width = pct;
          })
          .then((instance) => {
            console.log('✅ Unity instance created');
            window.unityInstance = instance;
            document.querySelector('#unity-loading-bar').style.display = 'none';
          })
          .catch((e) => {
            console.error('❌ Unity load failed:', e);
            unityShowBanner('Unity failed to load','error');
          });
        }
      };
      loader.onerror = (e) => {
        console.error('Error loading Unity loader script:', e);
        unityShowBanner('Could not load Unity loader.js','error');
      };
      document.body.appendChild(loader);
    </script>
  </body>
</html>
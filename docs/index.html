<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <title>Unity WebARProject</title>

    <!-- A-Frame + AR.js for NFT tracking -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

    <style>
      html, body {
        margin: 0; padding: 0; overflow: hidden; background: transparent;
      }
      #scene {
        position: absolute; top: 0; left: 0;
        width: 100vw; height: 100vh;
      }
      #unity-container,
      #unity-canvas,
      canvas {
        position: absolute; top: 0; left: 0;
        width: 100vw; height: 100vh;
        background: transparent !important;
        pointer-events: none;
      }
    </style>

    <script>
    Promise.all([
      fetch("StreamingAssets/functionManifest.json").then(r => r.json()),
      fetch("StreamingAssets/markerManifest.json").then(r => r.json())
    ])
    .then(([fnMan, mkMan]) => {
      // 1) Wire up Unity→JS stubs
      fnMan.functions.forEach(f => {
        window[f.jsName] = (...args) => {
          const payload = f.argCount === 1
            ? JSON.stringify(args[0])
            : JSON.stringify(args);
          window.unityInstance.SendMessage(f.objectName, f.methodName, payload);
        };
      });

      // 2) Inject markers + placeholders
      const scene = document.querySelector("a-scene");
      mkMan.urls.forEach(url => {
        const id  = url.split("/").pop();
        const nft = document.createElement("a-nft");
        nft.setAttribute("id",                  id);
        nft.setAttribute("type",                "nft");
        nft.setAttribute("url",                 url);
        nft.setAttribute("smooth",              "true");
        nft.setAttribute("smoothCount",         "30");
        nft.setAttribute("smoothTolerance",     "0.01");
        nft.setAttribute("smoothThreshold",     "5");
        nft.setAttribute("detectMinSimilarity", "0.3");
        nft.setAttribute("scale",               "0.2 0.2 0.2");
        nft.setAttribute("cube-follow",         "");

        // placeholder for Unity parenting
        const ph = document.createElement("a-entity");
        ph.setAttribute("id",       `${id}-ph`);
        ph.setAttribute("position", "0 0 0");
        nft.appendChild(ph);

        // optional ambient light
        const light = document.createElement("a-light");
        light.setAttribute("type",      "ambient");
        light.setAttribute("intensity", "1");
        nft.appendChild(light);

        scene.appendChild(nft);
      });

      // 3) Register cube-follow once
      AFRAME.registerComponent('cube-follow', {
        schema: {
          distanceFactor: { type: 'number', default: 1.5 },
          yOffset:        { type: 'number', default: 0.05 },
          smoothFactor:   { type: 'number', default: 0.2 }
        },

        init() {
          this.spawned    = false;
          this.lostCount  = 0;
          this.marker     = this.el;
          this.cameraEl   = this.el.sceneEl.querySelector('[camera]');
          this.smoothedPos  = new THREE.Vector3();
          this.smoothedQuat = new THREE.Quaternion();
          this.hasSmoothed  = false;
          this.phId = () => `${this.marker.id}-ph`;

          this.marker.addEventListener('markerFound', () => {
            if (!this.spawned && window.unityInstance?.SendMessage) {
              window.unityInstance.SendMessage('CubeSpawner','SpawnCube', this.phId());
              this.spawned    = true;
              this.lostCount  = 0;
            }
          });
          this.marker.addEventListener('markerLost', () => {
            if (this.spawned && window.unityInstance?.SendMessage) {
              window.unityInstance.SendMessage('CubeSpawner','DestroyCube', this.phId());
              this.spawned = false;
            }
          });
        },

        tick() {
          const u = window.unityInstance;
          if (!this.spawned || !u?.SendMessage) return;

          if (!this.marker.object3D.visible && ++this.lostCount > 5) {
            u.SendMessage('CubeSpawner','DestroyCube', this.phId());
            this.spawned   = false;
            this.lostCount = 0;
          }
          if (!this.marker.object3D.visible) return;
          this.lostCount = 0;

          // world-space marker & camera
          const worldPos  = new THREE.Vector3(), worldQuat = new THREE.Quaternion();
          this.marker.object3D.getWorldPosition(worldPos);
          this.marker.object3D.getWorldQuaternion(worldQuat);

          const camPos  = new THREE.Vector3(), camQuat = new THREE.Quaternion();
          this.cameraEl.object3D.getWorldPosition(camPos);
          this.cameraEl.object3D.getWorldQuaternion(camQuat);

          // relative (mm) → metres
          const relPosMm = worldPos.sub(camPos);
          const relQuat  = camQuat.clone().invert().multiply(worldQuat);
          const rawPos   = relPosMm.divideScalar(1000);

          // smoothing
          const α = this.data.smoothFactor;
          if (!this.hasSmoothed) {
            this.smoothedPos.copy(rawPos);
            this.smoothedQuat.copy(relQuat);
            this.hasSmoothed = true;
          } else {
            this.smoothedPos.lerp(rawPos, α);
            this.smoothedQuat.slerp(relQuat, α);
          }

          // scale & lift
          const df = this.data.distanceFactor, yf = this.data.yOffset, p = this.smoothedPos;
          const px = p.x * df, py = p.y * df + yf, pz = -p.z * df;

          // send update to Unity
          u.SendMessage(
            'CubeSpawner','UpdateTransformData',
            JSON.stringify({
              id:       this.phId(),
              position: { x:px, y:py, z:pz },
              rotation: {
                x: this.smoothedQuat.x,
                y: this.smoothedQuat.y,
                z: -this.smoothedQuat.z,
                w: this.smoothedQuat.w
              }
            })
          );
        }
      });
    })
    .catch(console.error);
    </script>
  </head>

  <body>
    <!-- AR.js Scene -->
    <a-scene
      id="scene" embedded vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true; alpha: true"
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: true;"
    >
      <a-entity camera></a-entity>
    </a-scene>

    <!-- Unity canvas & loader -->
    <div id="unity-container">
      <canvas id="unity-canvas" width="960" height="600" tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"></div>
      <div id="unity-footer">
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">UnityWebARProject</div>
      </div>
    </div>

    <script>
      function unityShowBanner(msg, type) {
        const b = document.querySelector("#unity-warning"),
              d = document.createElement("div");
        d.innerHTML = msg;
        d.style = type==="error"
          ? "background:red;padding:10px;"
          : type==="warning"
          ? "background:yellow;padding:10px;" : "";
        b.appendChild(d);
        if(type==="warning") setTimeout(()=>b.removeChild(d),5000);
      }

      const canvas   = document.getElementById("unity-canvas");
      const loaderUrl= "Build/doc.loader.js";
      const config   = {
        dataUrl:             "Build/doc.data",
        frameworkUrl:        "Build/doc.framework.js",
        codeUrl:             "Build/doc.wasm",
        streamingAssetsUrl:  "StreamingAssets",
        showBanner:          unityShowBanner,
        webglContextAttributes:{ alpha:true, premultipliedAlpha:false }
      };

      console.log("Injecting Unity loader:", loaderUrl);
      const unityLoader = document.createElement("script");
      unityLoader.src = loaderUrl;
      unityLoader.onload = () => {
        if (!window.unityInstance) {
          createUnityInstance(canvas, config, p => {
            document.querySelector("#unity-progress-bar-full")
                    .style.width = (100*p).toFixed(1) + "%";
          })
          .then(inst => {
            window.unityInstance = inst;
            document.querySelector("#unity-loading-bar").style.display = "none";
          })
          .catch(err => {
            console.error("Unity load failed:", err);
            unityShowBanner("Unity failed to load","error");
          });
        }
      };
      unityLoader.onerror = e => {
        console.error("Error loading Unity loader script:", e);
        unityShowBanner("Could not load Unity loader.js","error");
      };
      document.body.appendChild(unityLoader);
    </script>
  </body>
</html>
